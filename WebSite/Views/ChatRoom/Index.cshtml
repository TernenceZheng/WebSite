@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="@Url.Content("~/Scripts/jquery-1.8.2.min.js")"></script>
<script src="@Url.Content("~/Scripts/ui/jquery.ui.core.js")"></script>
<script src="@Url.Content("~/Scripts/ui/jquery.ui.widget.js")"></script>
<script src="@Url.Content("~/Scripts/ui/jquery.ui.mouse.js")"></script>
<script src="@Url.Content("~/Scripts/ui/jquery.ui.draggable.js")"></script>
<script src="@Url.Content("~/Scripts/ui/jquery.ui.resizable.js")"></script>
<script src="@Url.Content("~/Scripts/jquery.signalR-1.2.0.js")"></script>
<!-- *************************************************************** -->
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs" type="text/javascript"></script>
<!-- 這個參考是動態產生的，建置專案之後變自動建立此資料夾，務必在jQuery和signalR之後 -->
<!-- *************************************************************** -->
<style>
    .textbox
    {
        width: 700px;
        height: 30px;
    }
    .textbox_Private
    {
        width: 300px;
        height: 30px;
    }
</style>
<script type="text/javascript">
    $(function () {
        setScreen(false);

        // Declare a proxy to reference the hub. 
        // 記得改成您自己的 Hub檔「檔名」，在此，檔名第一個要用小寫。
        var chatHub = $.connection.chatHub;
        registerClientMethods(chatHub);  // 向後端的Hub，註冊 Clinet端（前端）的 function

        // Start Hub
        $.connection.hub.start().done(function () {
            registerEvents(chatHub)  //向後端的Hub，註冊 Clinet端（前端）的 function
        });
    });

    function setScreen(isLogin) {
        if (!isLogin) {
            $("#inputName").click();
        }
    }

    function registerEvents(chatHub) {

        $("#btnStartChat").click(function () {
            var name = $("#txtNickName").val();

            if (name.length > 0) {
                chatHub.server.connect(name);   //後端的 Connection方法，在前端，第一個字會改成小寫名稱
            }
            else {
                $("#errorName").show();
            }
        });


        $('#btnSendMsg').click(function () {
            var msg = $("#txtMessage").val();

            if (msg.length > 0) {
                var userName = $('#hdUserName').val();
                chatHub.server.sendMessageToAll(userName, msg);   //後端的 SendMessageToAll方法，在前端，第一個字會改成小寫名稱
                $("#txtMessage").val('');
            }
        });


        $("#txtNickName").keypress(function (e) {
            if (e.which == 13) {
                $("#btnStartChat").click();
            }
        });

        $("#txtMessage").keypress(function (e) {
            if (e.which == 13) {
                $('#btnSendMsg').click();
            }
        });
    }

    //**********************************************(start)
    //*** 向後端的Hub，註冊 Clinet端（前端）的 function
    function registerClientMethods(chatHub) {
        // Calls when user successfully logged in
        chatHub.client.onConnected = function (id, userName, allUsers, messages) {

            setScreen(true);

            $('#hdId').val(id);
            $('#hdUserName').val(userName);
            $('#spanUser').html(userName);

            // Add All Users
            for (i = 0; i < allUsers.length; i++) {
                AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName);
            }

            // Add Existing Messages
            for (i = 0; i < messages.length; i++) {
                AddMessage(messages[i].UserName, messages[i].Message);
            }
        }

        // On New User Connected。新的人員加入。
        chatHub.client.onNewUserConnected = function (id, name) {
            AddUser(chatHub, id, name);
        }


        // On User Disconnected。有人離線。
        chatHub.client.onUserDisconnected = function (id, userName) {
            $('#' + id).remove();

            var ctrId = 'private_' + id;
            $('#' + ctrId).remove();

            var disc = $('<div class="disconnect">"' + userName + '" logged off.</div>');
            //有人離線，出現警示視窗（通知）。

            $(disc).hide();
            $('#divusers').prepend(disc);
            $(disc).fadeIn(200).delay(2000).fadeOut(200);
        }

        chatHub.client.messageReceived = function (userName, message) {
            AddMessage(userName, message);
        }


        chatHub.client.sendPrivateMessage = function (windowId, fromUserName, message) {
            var ctrId = 'private_' + windowId;

            if ($('#' + ctrId).length == 0) {
                createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName);
                //開啟「前端的」私人聊天視窗。
            }

            $('#' + ctrId).find('#divMessage').append('<div class="message"><span class="userName">' + fromUserName + '</span>: ' + message + '</div>');

            // set scrollbar
            var height = $('#' + ctrId).find('#divMessage')[0].scrollHeight;
            $('#' + ctrId).find('#divMessage').scrollTop(height);
        }

    }
    //**********************************************(end)

    function AddUser(chatHub, id, name) {
        var userId = $('#hdId').val();
        var code = "";

        if (userId == id) {
            code = $(' <li><strong>Name:</strong>' + name + "</li>");
        }
        else {
            code = $('<li><strong>Name:</strong><a id="' + id + '" class="user" >' + name + '<a></li>');
            $(code).dblclick(function () {
                var id = $(this).attr('id');

                if (userId != id)
                    OpenPrivateChatWindow(chatHub, id, name);  //開啟「前端的」私人聊天視窗。
            });
        }

        $("#divusers").append(code);
    }

    function AddMessage(userName, message) {
        var userId = $('#hdId').val();
        if (userId == userName) {
            $('#divChatWindow').append('<dd><span class="label-success label label-default">' + userName + '</span>：<span>' + message + '</span></dd>');
        }
        else {
            $('#divChatWindow').append('<dd><span class="label-default label">' + userName + '</span>：<span>' + message + '</span></dd>');
        }



        var height = $('#divChatWindow')[0].scrollHeight;
        $('#divChatWindow').scrollTop(height);
    }

    function OpenPrivateChatWindow(chatHub, id, userName) {
        var ctrId = 'private_' + id;

        if ($('#' + ctrId).length > 0) return;

        createPrivateChatWindow(chatHub, id, ctrId, userName);  //開啟「前端的」私人聊天視窗。
    }

    //私人對話 的 聊天視窗。
    function createPrivateChatWindow(chatHub, userId, ctrId, userName) {
        var div = '<div id="' + ctrId + '" class="ui-widget-content draggable" rel="0">' +
                       '<div class="header">' +
                          '<div  style="float:right;">' +
                              '<img id="imgDelete"  style="cursor:pointer;" src="/Images/delete.png"/>' +
                           '</div>' +

                           '<span class="selText" rel="0">' + userName + '</span>' +
                       '</div>' +
                       '<div id="divMessage" class="messageArea">' +

                       '</div>' +
                       '<div class="buttonBar">' +
                          '<input id="txtPrivateMessage" class="msgText" type="text"   />' +
                          '<input id="btnSendMessage" class="submitButton button" type="button" value="Send（私人對話）"   />' +
                       '</div>' +
                    '</div>';

        var $div = $(div);

        // DELETE BUTTON IMAGE
        $div.find('#imgDelete').click(function () {
            $('#' + ctrId).remove();
        });

        // Send Button event
        $div.find("#btnSendMessage").click(function () {
            $textBox = $div.find("#txtPrivateMessage");
            var msg = $textBox.val();

            if (msg.length > 0) {
                chatHub.server.sendPrivateMessage(userId, msg);   //後端的 SendPrivateMessage方法，在前端，第一個字會改成小寫名稱
                $textBox.val('');
            }
        });

        // Text Box event
        $div.find("#txtPrivateMessage").keypress(function (e) {
            if (e.which == 13) {
                $div.find("#btnSendMessage").click();
            }
        });

        AddDivToContainer($div);
    }

    function AddDivToContainer($div) {
        $('#divContainer').prepend($div);

        $div.draggable({
            handle: ".header",
            stop: function () {

            }
        });

        ////$div.resizable({
        ////    stop: function () {

        ////    }
        ////});
    }
</script>
<!--呈現聊天室對話-->
<div class="box col-md-8">
    <div class="box-inner">
        <div class="box-header well" data-original-title="">
            <h2>
                公開聊天室</h2>
            <div class="box-icon">
                <a href="#" class="btn btn-close btn-round btn-default"><i class="glyphicon glyphicon-remove">
                </i></a>
            </div>
        </div>
        <div id="divChatWindow" class="box-content" style="height: 300px; overflow-y: scroll;">
        </div>
    </div>
</div>
<!--聊天室人員名單-->
<div class="box col-md-4">
    <div class="box-inner">
        <div class="box-header well" data-original-title="">
            <h2>
                <i class="glyphicon glyphicon-user"></i>聊天室人員</h2>
            <div class="box-icon">
                <a href="#" class="btn btn-minimize btn-round btn-default"><i class="glyphicon glyphicon-chevron-up">
                </i></a><a href="#" class="btn btn-close btn-round btn-default"><i class="glyphicon glyphicon-remove">
                </i></a>
            </div>
        </div>
        <div class="box-content">
            <div class="box-content" style="height: 300px; overflow-y: scroll;">
                <ul id="divusers" class="dashboard-list">
                </ul>
            </div>
        </div>
    </div>
</div>
<!--對話輸入-->
<div class="box col-md-8">
    <div class="box-inner">
        <div class="box-header well" data-original-title="">
            <h2>
                <i class="glyphicon glyphicon-th"></i>歡迎 <span id="spanUser"></span>
            </h2>
            <div class="box-icon">
                <a href="#" class="btn btn-setting btn-round btn-default"><i class="glyphicon glyphicon-cog">
                </i></a><a href="#" class="btn btn-minimize btn-round btn-default"><i class="glyphicon glyphicon-chevron-up">
                </i></a><a href="#" class="btn btn-close btn-round btn-default"><i class="glyphicon glyphicon-remove">
                </i></a>
            </div>
        </div>
        <div class="box-content">
            <div class="row">
                <div class="form-group has-success col-md-10">
                    <input class="textbox" type="text" id="txtMessage">
                    <button id="btnSendMsg" type="submit" class="btn btn-default">
                        留言</button>
                </div>
            </div>
        </div>
    </div>
    <input id="hdId" type="hidden" />
    <input id="hdUserName" type="hidden" />
</div>
<!--先要輸入名稱的輸入-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    ×</button>
                <h3>
                    請先輸入使用者名稱</h3>
            </div>
            <div class="modal-body">
                <div class="input-group col-md-4">
                    <span class="input-group-addon"><i class="glyphicon glyphicon-user red"></i></span>
                    <input id="txtNickName" type="text" class="form-control" placeholder="Username">
                    <p id="errorName" style="display: none;">
                        必填</p>
                </div>
            </div>
            <div class="modal-footer">
                <a id="btnStartChat" href="#" class="btn btn-primary" data-dismiss="modal">進入</a>
            </div>
        </div>
    </div>
</div>
<a id="inputName" href="#" class="btn btn-info btn-setting">加入聊天室</a>
<!--針對個人的對話框框-->
